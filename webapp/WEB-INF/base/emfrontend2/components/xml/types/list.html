
##required: catalogid, searchtype, view, fieldname
##optional: value, foreignkeyid and foreignkeyvalue

#set ($catalogidother = $context.getRequestParameter('catalogid'))
#if($catalogidother)
	#set ($catalogid = $catalogidother)
#end
#if(!$searchtype)
	#set ( $searchtype = $context.getRequestParameter("searchtype") )
#end
#ifnull ($fieldname)
	#set ($fieldname = $context.getRequestParameter('fieldname')) ##lastmodified
#end
#set ($view = $context.getRequestParameter('view')) 
##we need to load up the existing detail object

#set( $originalsearcher = $searcherManager.getSearcher($catalogid, $searchtype))
#if( !$detail) ##this is new. To reduce complexity we want to just load up the detail all the time
	#set ($fieldname = $context.getRequestParameter('fieldname')) ##lastmodified
	#set( $detail = $originalsearcher.getDetailForView($view, $fieldname, $user) )
#end

#set ($fieldname = $detail.id)
#set( $listid = $detail.getListId())
#set( $csslistid = "listdetail_$fieldname")

<div id="$csslistid" class="listdetailpicker">

#set( $lsearcher = $searcherManager.getSearcher( $detail.getListCatalogId(), $listid ))	
##optional things to filter the list
#set ($foreignkeyid = $detail.get("foreignkeyid") )

#set ($squery = $detail.query )

#if ($foreignkeyid)  ##Old code. We dont do this anymore?

	#if( !$foreignkeyvalue )
		#set ($foreignkeyvalue = $context.getRequestParameter('foreignkeyvalue'))
	#end
	#if( !$foreignkeyvalue )
		#set ($foreignkeyvalue = $context.getRequestParameter($foreignkeyid))
	#end
	#set( $foreigndetail = $originalsearcher.getDetailForView($view, $foreignkeyid, $user) )
	
	#if( $foreigndetail && $foreigndetail.listid )
		#set( $foreignfield = $foreigndetail.listid )
	#else
		#set( $foreignfield = $foreignkeyid )
	#end
	#set ($query = $lsearcher.createSearchQuery())
	#set ($o = $query.setAndTogether(false))
	#set ($o = $query.addExact($foreignfield, $foreignkeyvalue))

	#if( $foreignkeyid)
		<script type="text/javascript">
			addListListener("$foreignkeyid", "${fieldname}");
		</script>
	#end
	
#elseif( $squery && (!$detail.getType() || $detail.getType() != "textjoin") )
	#set ($query = $lsearcher.parse($squery))
#else
	##New way to do this?
	#set ($listfilterid = $detail.get("listfilterid") ) ##has to have same column name in both tables
	#if( $listfilterid)
		#set( $remotevalue  = $data.get($listfilterid) )
		#if(!$remotevalue)
			#set ($remotevalue = $context.replaceProperty($detail.defaultvalue) )
		#end
		#if( $remotevalue)
			#set($query = $lsearcher.query().exact($listfilterid,$remotevalue).getQuery() )
		#end	
	#end	
	#ifnull ($query)
		#set ($query = $lsearcher.createSearchQuery())
		#set ($o = $query.addMatches("id", "*")) 
	#end	
#end

$query.setSortBy($detail.getDefaultSort())
####$lsearcher.addShowOnly($context, $query) 
#set ($types = $lsearcher.search($context, $query))

#ifnull ($value)
	#set ($value = $context.getRequestParameter('val'))
#end
#ifnull ($value)
	#set ($value = $val)
#end
#ifnull ($value)
	#set ($value = $context.replaceProperty($detail.defaultvalue) )
#end

#set($searchfield = $detail.getId() )

#set( $valueid = "$fieldname" )
#if($types)
	<select name="${fieldname}.value" 
			class="listdropdown choose-select detail-select form-control #if($detail.isRequired() && !$multiedit) required #end" 
			listid="$listid" 
			id="${valueid}value"
			data-listid="$listid" 
			data-searchtype= '$searchtype'
			data-searchfield="$searchfield"
        	onchange="if( typeof updatelisteners == 'function' )updatelisteners('$catalogid','$searchtype','$!view','$fieldname');"
        	#if($removeclear) data-allowclear="false" #end
	>
	#if ($detail.blankoption != "false")
	<option value=""></option>
	#end
	$types.setHitsPerPage(1000)
	#foreach( $type in $types.getPageOfHits() )
		#set( $key = $type.id)
		#if($detail.render)
   			#set($label = $searcherManager.getValue($catalogid, $detail.render, $type.properties))
		#else
   		#set($label = $type.getName($context.getLanguage()))
		#end
		<option value="$key" #if( $value && $key == $value ) selected #end>#esc($label)</option>
	#end
	#if($hits && $hits.size() > 1000 )
		<option value="-1">1000 [[limit reached]]</option>
	#end
   </select>
 
   
#else
	[[No values found]] 
#end
 #if( $caneditlists)
		<a class="emdialog addnewitem btn btn-xs btn-light" data-dialogid="inlineedit" 
			href="$apphome/views/settings/lists/datamanager/edit/inline.html?searchtype=$listid&update=${valueid}value" title="[[Add New]] $detail" data-hidefooter="true">+ [[New]] $detail</a>
  #end
  <div class="clearfix"></div>
</div>
